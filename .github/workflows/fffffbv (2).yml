name: DSSAxsdcad (Win10)

on:
  workflow_dispatch:

jobs:
  deployment:
    # تم التغيير هنا ليعمل بنسخة Windows 10 (Server 2019)
    runs-on: windows-2019
    timeout-minutes: 360

    env:
      # ====================================================
      # المتغيرات الخاصة بك
      # ====================================================
      aa1: "tskey-auth-kH5PxYvmdX11CNTRL-t6Tskjywq3U2NkJNTPov3U92dHXz1dP7"
      aa2: "DDDDDDDAAAA"
      aa3: "Zxxz4444"
      
      NST_URL: "https://tinyurl.com/nstkkdkac44"
      RUST_URL: "https://tinyurl.com/ruskaaaaa11"
      ZIP_URL: "https://tinyurl.com/filesdownlaodkkda45"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # ====================================================
      # الخطوة 1: إعداد RDP والمستخدمين و Tailscale
      # ====================================================
      - name: Setup RDP, Users & Tailscale
        shell: pwsh
        run: |
          Write-Host "==== 1. CONFIGURING RDP & FIREWALL (Win 10/2019) ===="
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name fDenyTSConnections -Value 0 -Force
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name UserAuthentication -Value 0 -Force
          Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name SecurityLayer -Value 0 -Force
          netsh advfirewall firewall delete rule name="Remote-Desktop-Access" 2>$null | Out-Null
          netsh advfirewall firewall add rule name="Remote-Desktop-Access" dir=in action=allow protocol=TCP localport=3389 | Out-Null
          Restart-Service TermService -Force
          
          Write-Host "==== 2. SETTING UP USERS ===="
          $User = $env:aa2
          $Pass = $env:aa3
          $Secure = ConvertTo-SecureString $Pass -AsPlainText -Force
          
          # 1. تغيير باسورد المستخدم الأساسي الحالي
          $current = $env:USERNAME
          Set-LocalUser -Name $current -Password $Secure
          Write-Host " -> Main User ($current) password updated."
          
          # 2. تغيير باسورد runneradmin احتياطياً
          if ($current -ne "runneradmin") {
              $r = Get-LocalUser -Name "runneradmin" -ErrorAction SilentlyContinue
              if ($r) { Set-LocalUser -Name "runneradmin" -Password $Secure; Write-Host " -> RunnerAdmin password updated." }
          }
          
          # 3. إنشاء المستخدم الجديد
          $u = Get-LocalUser -Name $User -ErrorAction SilentlyContinue
          if (-not $u) {
              New-LocalUser -Name $User -Password $Secure -FullName $User -Description "RDP User" -AccountNeverExpires
              Add-LocalGroupMember Administrators $User
              Add-LocalGroupMember "Remote Desktop Users" $User
              Write-Host " -> New User ($User) created."
          } else {
              Set-LocalUser -Name $User -Password $Secure
              Write-Host " -> New User ($User) updated."
          }

          Write-Host "==== 3. INSTALLING TAILSCALE ===="
          $TsKey = $env:aa1
          if ($TsKey) {
              $TsUrl = 'https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi'
              $TsMsi = Join-Path $env:TEMP 'tailscale.msi'
              Invoke-WebRequest $TsUrl -OutFile $TsMsi -UseBasicParsing
              Start-Process msiexec.exe -ArgumentList '/i', $TsMsi, '/quiet', '/norestart' -Wait
              
              $TsExe = Join-Path $env:ProgramFiles 'Tailscale\tailscale.exe'
              $HostName = "RDP-Win10-$env:GITHUB_RUN_NUMBER"
              & $TsExe up --authkey=$TsKey --hostname=$HostName
              
              Start-Sleep -Seconds 3
              $ip = & $TsExe ip -4 2>$null
              Write-Host " -> Tailscale IP: $ip"
          }

      # ====================================================
      # الخطوة 2: تثبيت البرامج بالترتيب الصحيح
      # ====================================================
      - name: Install Software (Rust -> Zip -> NST)
        shell: pwsh
        run: |
          # --- دوال مساعدة ---
          function Download-File($u, $o) {
              try { Invoke-WebRequest -Uri $u -OutFile $o -UseBasicParsing -TimeoutSec 600 -ErrorAction Stop; return $true }
              catch { try { & curl.exe -L $u -o $o --retry 2; if (Test-Path $o) { return $true } } catch {} }
              return $false
          }
          
          $TempDir = Join-Path $env:TEMP 'install_tasks'
          New-Item -Path $TempDir -ItemType Directory -Force | Out-Null
          $User = $env:aa2
          
          # ---------------------------------------------------
          # 1. تثبيت RustDesk (أولاً)
          # ---------------------------------------------------
          Write-Host "==== STEP 1: RUSTDESK INSTALL ===="
          $rustExe = Join-Path $TempDir 'rustdesk-install.exe'
          if (Download-File $env:RUST_URL $rustExe) {
              Start-Process -FilePath $rustExe -ArgumentList "--silent-install" -NoNewWindow
              
              # حلقة الانتظار المهمة
              $installedPath = Join-Path $env:ProgramFiles 'RustDesk\RustDesk.exe'
              Write-Host " -> Waiting for installation to finish..."
              for ($i=0; $i -lt 30; $i++) {
                  if (Test-Path $installedPath) { Write-Host " -> Detected!"; break }
                  Start-Sleep -Seconds 2
              }
              try { Start-Service -Name rustdesk -ErrorAction SilentlyContinue; Start-Sleep -Seconds 2 } catch {}
          }
          
          # ---------------------------------------------------
          # 2. استخراج الملفات (ثانياً)
          # ---------------------------------------------------
          Write-Host "==== STEP 2: EXTRACT ZIP ===="
          $zipFile = Join-Path $TempDir 'payload.zip'
          if (Download-File $env:ZIP_URL $zipFile) {
              $profiles = @($env:USERPROFILE)
              $targetProfile = "C:\Users\$User"
              if (Test-Path $targetProfile) { $profiles += $targetProfile }
              
              foreach ($p in $profiles) {
                  $dLoads = Join-Path $p 'Downloads'
                  $dDesk  = Join-Path $p 'Desktop'
                  foreach ($loc in @($dLoads, $dDesk)) {
                      try { 
                          New-Item -ItemType Directory -Path $loc -Force | Out-Null
                          Expand-Archive -Path $zipFile -DestinationPath $loc -Force
                          Write-Host " -> Extracted to: $loc"
                      } catch { Write-Warning "Failed extract to $loc" }
                  }
              }
          }
          
          # ---------------------------------------------------
          # 3. تثبيت NST Browser (ثالثاً)
          # ---------------------------------------------------
          Write-Host "==== STEP 3: NST BROWSER ===="
          $nstExe = Join-Path $TempDir 'nst.exe'
          if (Download-File $env:NST_URL $nstExe) {
              # تثبيت صامت جداً
              $args = @("/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART", "/SP-", "/S")
              Start-Process -FilePath $nstExe -ArgumentList $args -NoNewWindow -Wait
              Write-Host " -> NST Installed."
          }
          
          # ---------------------------------------------------
          # 4. تعيين كلمة سر RustDesk (أخيراً)
          # ---------------------------------------------------
          Write-Host "==== STEP 4: RUSTDESK PASSWORD ===="
          $installedPath = Join-Path $env:ProgramFiles 'RustDesk\RustDesk.exe'
          if (Test-Path $installedPath) {
              try { Stop-Service rustdesk -Force -ErrorAction SilentlyContinue } catch {}
              try { Stop-Process -Name rustdesk -Force -ErrorAction SilentlyContinue } catch {}
              
              & $installedPath --password "Vbbv4444" | Out-Null
              Start-Sleep -Seconds 1
              
              try { Start-Service rustdesk; Write-Host " -> Password Set & Service Started." } 
              catch { & net start rustdesk | Out-Null }
          }

      # ====================================================
      # الخطوة 3: إبقاء الجلسة تعمل (Keep Alive)
      # ====================================================
      - name: Keep Session Alive
        shell: pwsh
        run: |
          $KeepAliveMinutes = 350
          Write-Host "==== SESSION STARTED: $KeepAliveMinutes Minutes ===="
          $sw = [Diagnostics.Stopwatch]::StartNew()
          while ($sw.Elapsed.TotalMinutes -lt $KeepAliveMinutes) {
            $left = [math]::Round($KeepAliveMinutes - $sw.Elapsed.TotalMinutes)
            Write-Host "Alive - $left minutes remaining..."
            Start-Sleep -Seconds 60
          }
