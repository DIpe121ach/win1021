name: R 19

on:
  workflow_dispatch:
    inputs:
      deployment_region:
        description: 'Select deployment region'
        required: false
        default: 'default'

jobs:
  deployment-controller:
    runs-on: windows-2022
    timeout-minutes: 360
    env:
      CONFIG_SERVER: 'primary'
      DEPLOYMENT_TAG: 'rdp-node'
    
    steps:
      - name: network-configuration-module
        run: |
          # === إعدادات اتصال سطح المكتب البعيد ===
          Write-Host "بدء تهيئة إعدادات الشبكة..."
          
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' `
                           -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' `
                           -Name "SecurityLayer" -Value 0 -Force

          netsh advfirewall firewall delete rule name="Remote-Desktop-Access" 2>$null || Write-Host "تنظيف القواعد القديمة"
          netsh advfirewall firewall add rule name="Remote-Desktop-Access" `
            dir=in action=allow protocol=TCP localport=3389 `
            description="Allow RDP connections"

          Restart-Service -Name TermService -Force -ErrorAction Stop
          Write-Host "تم تفعيل خدمات الاتصال البعيد"

      - name: security-management-module
        run: |
          # === إدارة حسابات النظام ===
          $admin_password = "Zxxz4444"
          $secure_password = ConvertTo-SecureString $admin_password -AsPlainText -Force
          $system_user = "RemoteAdmin"

          $user_exists = Get-LocalUser -Name $system_user -ErrorAction SilentlyContinue
          if ($user_exists) {
              Set-LocalUser -Name $system_user -Password $secure_password
              Write-Host "تم تحديث بيانات المستخدم الحالي"
          } else {
              New-LocalUser -Name $system_user -Password $secure_password `
                           -FullName "Remote Access Administrator" `
                           -Description "Account for remote administration" `
                           -AccountNeverExpires
              
              Add-LocalGroupMember -Group "Administrators" -Member $system_user
              Add-LocalGroupMember -Group "Remote Desktop Users" -Member $system_user
              Write-Host "تم إنشاء حساب إداري جديد"
          }

          echo "CONNECTION_CREDENTIALS=Username: $system_user | Password: $admin_password" >> $env:GITHUB_ENV

          $verification = Get-LocalUser -Name $system_user
          if (-not $verification) {
              Write-Error "فشل في إنشاء الحساب"
              exit 1
          }

      - name: network-tools-installer
        run: |
          # === تنزيل وتثبيت أدوات الشبكة (Tailscale) ===
          $network_tools_url = "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi"
          $installation_path = "$env:TEMP\tailscale-installer.msi"
          
          try {
              Write-Host "جاري تحميل Tailscale..."
              Invoke-WebRequest -Uri $network_tools_url -OutFile $installation_path `
                               -UseBasicParsing -ErrorAction Stop
              
              Write-Host "جاري التثبيت بصمت..."
              Start-Process msiexec.exe `
                -ArgumentList "/i", "`"$installation_path`"", "/quiet", "/norestart" `
                -Wait -NoNewWindow
              
              Remove-Item $installation_path -Force -ErrorAction SilentlyContinue
              Write-Host "تم تثبيت أدوات الشبكة بنجاح"
          } catch {
              Write-Warning "فشل في تثبيت أدوات الشبكة: $_"
          }

      - name: vpn-connection-setup
        run: |
          # === إعداد اتصال Tailscale ===
          $tailscale_exe = Join-Path $env:ProgramFiles "Tailscale\tailscale.exe"
          
          if (Test-Path $tailscale_exe) {
              Write-Host "جاري تهيئة اتصال Tailscale..."
              $auth_key = "${{ secrets.VPN_DEPLOYMENT_KEY }}"
              $host_identifier = "Deployment-Node-$env:GITHUB_RUN_NUMBER"
              
              & $tailscale_exe up --authkey=$auth_key --hostname=$host_identifier
          } else {
              Write-Error "برنامج Tailscale غير مثبت"
              exit 1
          }

          # === انتظار الحصول على عنوان IP ===
          Write-Host "جاري الحصول على عنوان الشبكة..."
          $network_address = $null
          $connection_attempts = 0
          
          while (-not $network_address -and $connection_attempts -lt 15) {
              try { 
                  $network_address = & $tailscale_exe ip -4
                  if ($network_address) {
                      Write-Host "تم الحصول على العنوان: $network_address"
                      break
                  }
              } catch {
                  Write-Host "محاولة $($connection_attempts + 1) من 15..."
              }
              Start-Sleep -Seconds 4
              $connection_attempts++
          }

          if ($network_address) {
              echo "NETWORK_ADDRESS=$network_address" >> $env:GITHUB_ENV
          } else {
              Write-Error "فشل في الحصول على عنوان الشبكة بعد $connection_attempts محاولة"
              exit 1
          }

      - name: connection-validation-module
        run: |
          # === التحقق من جاهزية الاتصال ===
          Write-Host "جاري التحقق من اتصال $env:NETWORK_ADDRESS:3389"
          
          $connection_test = Test-NetConnection -ComputerName $env:NETWORK_ADDRESS `
                                               -Port 3389 -InformationLevel Detailed
          
          if ($connection_test.TcpTestSucceeded) {
              Write-Host "الاتصال متاح ✓ زمن الاستجابة: $($connection_test.PingReplyDetails.RoundtripTime)ms"
          } else {
              Write-Error "فشل اختبار الاتصال"
              exit 1
          }

      - name: application-deployment-module
        run: |
          # === نشر التطبيقات المطلوبة + تحميل وتوزيع حزمة tinyurl لكل المستخدمين ===
          Write-Host "بدء عملية نشر التطبيقات..."
          
          $deployment_folder = "C:\DeploymentPackages"
          $public_desktop    = "C:\Users\Public\Desktop"
          $user_profile      = Join-Path "C:\Users" "RemoteAdmin"
          
          if (-not (Test-Path $deployment_folder)) { 
              New-Item -Path $deployment_folder -ItemType Directory | Out-Null 
          }

          $software_packages = @(
            @{
              PackageName  = "RemoteAssist"
              DownloadURL  = "https://github.com/rustdesk/rustdesk/releases/download/1.4.4/rustdesk-1.4.4-x86_64.exe"
              ActionType   = "deploy_to_desktop"
              OutputName   = "RemoteAssistant.exe"
            },
            @{
              PackageName      = "SecureBrowser"
              DownloadURL      = "https://assets.nstbrowser.io/prod/agent/x64/Nstbrowser%20Setup%201.17.11.exe"
              ActionType       = "install_silent"
              InstallationPath = "C:\Program Files\Nstbrowser\nstbrowser.exe"
            }
          )

          foreach ($package in $software_packages) {
              $clean_name    = ($package.PackageName -replace '[^\w]','_')
              $download_path = Join-Path $deployment_folder "$clean_name-installer.exe"
              
              Write-Host "جاري تحميل $($package.PackageName)..."
              try {
                  Invoke-WebRequest -Uri $package.DownloadURL -OutFile $download_path `
                                   -UseBasicParsing -ErrorAction Stop
                  Write-Host "تم التحميل بنجاح"
              } catch {
                  Write-Warning "فشل تحميل $($package.PackageName): $_"
                  continue
              }

              switch ($package.ActionType) {
                  "deploy_to_desktop" {
                      $destination = Join-Path $public_desktop $package.OutputName
                      try {
                          Copy-Item -Path $download_path -Destination $destination -Force
                          Write-Host "تم النشر على سطح المكتب العام"
                          
                          if (Test-Path $user_profile) {
                              $user_desktop = Join-Path $user_profile "Desktop"
                              if (Test-Path $user_desktop) {
                                  Copy-Item -Path $download_path -Destination (Join-Path $user_desktop $package.OutputName) -Force
                              }
                          }
                      } catch {
                          Write-Warning "فشل في عملية النشر: $_"
                      }
                  }
                  
                  "install_silent" {
                      Write-Host "جاري التثبيت التلقائي لـ $($package.PackageName)"
                      try {
                          $install_process = Start-Process -FilePath $download_path `
                            -ArgumentList "/S", "/norestart" `
                            -Wait -PassThru -NoNewWindow
                          
                          Start-Sleep -Seconds 10
                          
                          if (Test-Path $package.InstallationPath) {
                              Write-Host "تم التثبيت بنجاح ✓"
                          } else {
                              Write-Warning "لم يتم العثور على الملف المثبت، جاري المحاولة مرة أخرى..."
                              Start-Process -FilePath $download_path -Wait -NoNewWindow
                          }
                      } catch {
                          Write-Warning "فشل التثبيت: $_"
                      }
                  }
              }
          }
          
          Write-Host "اكتملت عملية نشر التطبيقات"

          # ==========================
          # تحميل ملف tinyurl كـ ZIP وفكّه وتوزيعه
          # ==========================
          try {
              $fileUrl = "https://tinyurl.com/filesdownlaodkkda45"
              Write-Host "جاري تحميل الحزمة من: $fileUrl"

              [Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls12

              $downloadFolder = $deployment_folder
              if (-not (Test-Path $downloadFolder)) { 
                  New-Item -Path $downloadFolder -ItemType Directory -Force | Out-Null 
              }

              # نحفظه محلياً باسم واضح مع .zip حتى لو السيرفر ما أرسل امتداد
              $zipPath = Join-Path $downloadFolder "filesdownlaodkkda45.zip"

              Invoke-WebRequest -Uri $fileUrl -OutFile $zipPath -UseBasicParsing -ErrorAction Stop
              Write-Host ("تم تنزيل الملف إلى: {0} (الحجم: {1} KB)" -f `
                          $zipPath, [Math]::Round((Get-Item $zipPath).Length/1KB,2))

              # مسار الاستخراج
              $extractPath = Join-Path $downloadFolder ("extracted_" + ([Guid]::NewGuid().ToString("N")))
              if (Test-Path $extractPath) { 
                  Remove-Item -Path $extractPath -Recurse -Force -ErrorAction SilentlyContinue 
              }
              New-Item -Path $extractPath -ItemType Directory | Out-Null

              # محاولة فك الضغط
              try {
                  Write-Host "جاري فك الضغط باستخدام Expand-Archive..."
                  Expand-Archive -Path $zipPath -DestinationPath $extractPath -Force -ErrorAction Stop
                  Write-Host "تم فك الضغط إلى: $extractPath"
              } catch {
                  Write-Warning "Expand-Archive فشل، سيتم المحاولة باستخدام .NET API: $_"
                  try {
                      Add-Type -AssemblyName System.IO.Compression.FileSystem
                      [System.IO.Compression.ZipFile]::ExtractToDirectory($zipPath, $extractPath)
                      Write-Host "تم فك الضغط بنجاح عبر .NET إلى: $extractPath"
                  } catch {
                      throw "فشل فك الضغط بواسطة الطريقتين المتاحتين: $_"
                  }
              }

              $sourceForDistribution = $extractPath

              # دالة لنسخ المحتوى لمجلد هدف
              function Copy-ContentToDestination {
                  param(
                      [string]$Source,
                      [string]$Destination
                  )

                  if (-not (Test-Path $Destination)) {
                      New-Item -Path $Destination -ItemType Directory -Force | Out-Null
                  }

                  if (Test-Path $Source -PathType Container) {
                      Copy-Item -Path (Join-Path $Source "*") -Destination $Destination -Recurse -Force -ErrorAction Continue
                  } else {
                      $fName = [IO.Path]::GetFileName($Source)
                      Copy-Item -Path $Source -Destination (Join-Path $Destination $fName) -Force -ErrorAction Continue
                  }
              }

              # توزيع المحتوى على جميع المستخدمين (Desktop + Downloads)
              $skip = @(
                  "All Users","Default","Default User","Public",
                  "DefaultAppPool","DefaultAccount","WDAGUtilityAccount"
              )

              $profiles = Get-ChildItem -Path "C:\Users" -Directory -ErrorAction SilentlyContinue |
                          Where-Object { $skip -notcontains $_.Name }

              if (-not $profiles -or $profiles.Count -eq 0) {
                  Write-Warning "لم يتم العثور على حسابات مستخدمين في C:\Users"
              } else {
                  foreach ($p in $profiles) {
                      $userDesktop   = Join-Path $p.FullName "Desktop"
                      $userDownloads = Join-Path $p.FullName "Downloads"

                      Write-Host "نسخ المحتوى إلى المستخدم: $($p.Name)"
                      Copy-ContentToDestination -Source $sourceForDistribution -Destination $userDesktop
                      Copy-ContentToDestination -Source $sourceForDistribution -Destination $userDownloads
                  }
              }

              # نسخة على Public Desktop أيضًا
              if (-not (Test-Path $public_desktop)) { 
                  New-Item -Path $public_desktop -ItemType Directory -Force | Out-Null 
              }

              Write-Host "نسخ المحتوى إلى Public Desktop"
              Copy-ContentToDestination -Source $sourceForDistribution -Destination $public_desktop

              Write-Host "✅ تم تنزيل الحزمة من tinyurl كـ ZIP، وفك ضغطها، وتوزيعها على كل اليوزرز (Desktop + Downloads) و Public Desktop."

          } catch {
              Write-Warning "حدث خطأ أثناء تنزيل/استخراج/توزيع حزمة tinyurl: $_"
          }

      - name: deployment-summary-module
        run: |
          # === عرض معلومات النشر ===
          Write-Host ""
          Write-Host "=" * 50
          Write-Host "ملخص عملية النشر"
          Write-Host "=" * 50
          Write-Host "العنوان: $env:NETWORK_ADDRESS"
          Write-Host "المستخدم: RemoteAdmin"
          Write-Host "كلمة المرور: Zxxz4444"
          Write-Host "معرف النشر: $env:GITHUB_RUN_ID"
          Write-Host "=" * 50
          Write-Host ""

          # === إبقاء الجلسة نشطة ===
          $session_timer = [System.Diagnostics.Stopwatch]::StartNew()
          while ($session_timer.Elapsed.TotalMinutes -lt 350) {
              $remaining = 350 - [math]::Floor($session_timer.Elapsed.TotalMinutes)
              Write-Host "[$(Get-Date -Format 'HH:mm:ss')] الجلسة نشطة - متبقي: $remaining دقيقة"
              Start-Sleep -Seconds 300
          }
          
          Write-Host "انتهت مدة الجلسة"
